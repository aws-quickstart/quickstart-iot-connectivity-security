:xrefstyle: short

[#architecture1]
.IoT Connectivity and Security Quick Start conceptual diagram
image::../images/architecture_diagram_overview.png[Architecture]

 <<architecture1>> shows a high-level view of the IoT Connectivity 
 and Security Quick Start in the AWS cloud 
 and on the end user’s web app and device. 

* In the AWS Cloud:
    ** *AWS IoT Core* allows IoT device registration using a https://aws.amazon.com/blogs/iot/just-in-time-registration-of-device-certificates-on-aws-iot/[Lambda-based just in time registration^] with your own certificate authority (CA) and device certificates issued by the CA. The service also provides command and control of IoT devices using the Device Shadow capability.
    ** *AWS IoT Device Management* sets up thing (device) groups, assigns devices to different thing groups based on the stage of IoT device life cycle (inactive, active, quarantine, and troubleshooting) and attaches IoT policies to each thing group to manage access control on the devices.
    ** *AWS IoT Device Defender* audits IoT device cloud-side configurations against AWS security best practices and monitors device behaviors for anomalies once devices are connected with AWS IoT Core. It also provides built-in mitigation actions, such as switching a thing to a different thing group with the corresponding IoT policies attached, which can be used to respond to anomalies.
    ** *Amazon DynamoDB* supports both storing IoT device telemetry data and accessing such data via the end user web app.
    ** *Amazon Cognito* authenticates the IoT device end user to access the web app so that they can activate and interact with the device for various tasks.
    ** *API endpoints* provide the service endpoints for device activation, command and control and device/telemetry querying that the IoT device end user requests through the web app.
    ** *Lambda JITR function* is triggered by AWS IoT rule to register a device and place it in the ‘Inactive Group’ under AWS IoT Device Management.
    ** *Lambda cnc function* is used in an API request to update a device shadow (command and control). 
    ** *Lambda query function* is used in an API request to query customer devices and device telemetry.

* On the IoT device and end user’s web app:
    ** *The IoT device* is registered in AWS IoT with the just-in-time registration process: 
        *** The end user device uses a device certificate issued by the registered CA as its unique identity; its device certificate is registered and activated in AWS IoT Core and attached to its thingName; its thingName is created in AWS IoT Core Registry with the CN of the device certificate; its thingName is also stored in Amazon DynamoDB to support the features of the web app.
        *** Upon end user activating the device, it is moved from the ‘Inactive Group’ to the ‘Active Group’ with IoT policies granting it with the minimum permissions it needs to perform its functions. 
    *** *The end user’s web app* is created so that the consumer (purchaser) of an IoT device can sign up/sign into the app via Amazon Cognito, activate their device by making requests to Amazon API Gateway backed by a custom Lambda function; the app also allows the consumer (purchaser) to interact with the device for command and control and to view device telemetry.

=== Detailed Architecture 

[#architecture2]
.Architecture of the IoT Connectivity and Security Quick Start
image::../images/architecture_diagram.png[Architecture]

As shown in <<architecture2>>, the IoT Connectivity and Security Quick Starts sets up the following resources: 

*End user device and web app*

* *Device*. End-user IoT device.
* *Device agent*.  https://github.com/awslabs/aws-iot-device-client[AWS IoT Device Client^] or any supported MQTT client that lets you connect your devices to AWS IoT Core, and access AWS IoT Device Management and AWS IoT Device Defender features by default. 
* *End user web app:* The web app is a vuejs front end that is published by AWS Amplify. Amplify handles webpage file storage and distribution. The frontend interacts with the iotquickstartrest API Gateway. User identities are managed with Amazon Cognito. Users can exchange their credentials for a JWT token. All API calls must include the JWT in the Authorization header, which also provides the Lambda function to register the customerAccount.


*IoT Core*

* AWS IoT Core facilitates https://aws.amazon.com/blogs/iot/just-in-time-registration-of-device-certificates-on-aws-iot/[IoT device just in time registration^] using an AWS Lambda backed AWS IoT rule on the registration topic: $aws/events/certificates/registered/+ .
* *Lambda JITR*. AWS IoT rule triggers the Lambda JITR function to register the device and place it in the ‘Inactive Group’ under AWS IoT Device Management.
* AWS IoT Core facilitates IoT device shadow update for command and control using an AWS Lambda rule on the Shadow update topic: $aws/things/thingName/shadow/update/accepted .
* AWS IoT Core collects IoT device telemetry data to a designated topic: dt/foundationapp/#/sensor1 . 


*IoT Device Management*

* The service sets up thing (device) groups and assigns devices to different thing groups based on the stage of IoT device life cycle (inactive, active, quarantine, and troubleshooting).
* *IoT policies*: AWS IoT Device Management attaches IoT policies to each thing group to manage access control on the devices.
* *IoT Things or Shadows*: Each device is registered in AWS IoT registry as a “thing“ with thing attributes (e.g., thingName, identity in the form of X.509 certificate) and owns one or multiple shadow (https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html) documents to describe its state.


*IoT Device Defender (Security Management)*

* This service audits IoT device cloud-side configurations against AWS security best practices and monitors device behaviors for anomalies once devices are connected with AWS IoT Core.
* It also provides prebuilt mitigation actions such as switching a thing to a different thing group and achieving actions such as quarantine with the corresponding IoT policies attached to the thing group
* *CloudWatch.* AWS IoT Device Defender publishes audit and detect alarms to Amazon CloudWatch as metrics.
* *Simple Notification Service.* AWS IoT Device Defender also publishes audit and detect alarms to Amazon SNS if you configured SNS topics to receive Device Defender alarms.


*API: Get Data & API: Command & Control*
The Quick Start uses the following API endpoints:

* /register/{thingName}: GET, if thing is in Inactive thing group and not registered to a customer in the Dynamodb products table, the Lambda function moves thing from Inactive to Active thing group, updates thingName in product table to have key account={customerAccount}, and adds thing attribute account={customerAccount}.
* /thingshadow/${thingName}: POST, body={key=${shadowKey}, value=${shadowDesiredValue}}, checks if thingName is registered to customerAccount in product DynamoDB table. If yes, update thing shadow with desired value.
* /deviceData/{thingName}: GET, deviceData lambda, Queries the last telemetry data points (up to 1 MB) for customerAccount-thingName
* /devices: GET, listdevices lambda, Queries customers devices (up to 1 MB)


*Lambda: Command & Control & Lambda Query Data*. 
Registered and active IoT devices have permissions to publish/subscribe to topics to interact with their shadow. These devices can publish to:
....
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get
....
and subscribe to:
....
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/accepted
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/rejected
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/documents
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/delta
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get/accepted
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get/rejected
....
Devices should publish the "reported" values within the shadow and read from the "desired" values. Cloud interactions should publish to 
"desired" and read from "reported" values in the shadow. 

*Update thing shadow desired.* The API request /thingshadow/${thingName}: POST, body={key=${shadowKey}, value=${shadowDesiredValue}} described above achieves this action.

*DynamoDB.* This service supports both storing IoT device telemetry data and accessing such data via the end user web app.



