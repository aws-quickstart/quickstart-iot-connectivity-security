:xrefstyle: short

Deploying this Quick Start for a new virtual private cloud (VPC) with
default parameters builds the following {partner-product-short-name} environment in the
AWS Cloud.

// Replace this example diagram with your own. Follow our wiki guidelines: https://w.amazon.com/bin/view/AWS_Quick_Starts/Process_for_PSAs/#HPrepareyourarchitecturediagram. Upload your source PowerPoint file to the GitHub {deployment name}/docs/images/ directory in this repo. 

[#architecture1]
.Quick Start architecture for {partner-product-short-name} on AWS
image::../images/architecture_diagram.png[Architecture]

As shown in <<architecture1>>, the Quick Start sets up the following:

* IoT device registration on first connect using https://aws.amazon.com/blogs/iot/just-in-time-registration-of-device-certificates-on-aws-iot/[just in time registration^] with your own certificate authority (CA).
* End customer web application to register devices to your account, to view device telemetry data of registered devices, and to perform command and control for registered devices.
* IoT device telemetry.
* IoT device command and control.
* IoT device management.
* IoT device security management enabling AWS IoT Device Defender ML Detect and Audit.
//* Amplify based end user app for device command and control. 
//* The app uses a Vue.js based frontend. 
//* An API gateway to expose the APIs.
//* Lambda functions for API backend.
//* DynamoDB as storage layer for device information and Cognito for user authentication.
//* AWS IoT Core setup uses following IoT Rules:
//** IoT Rule to register devices on first connect.
//** IoT Rule to accept telemetry messages from devices.
//** IoT Rule to accept telemetry messages from devices.
//* AWS IoT Groups for devices to be part of during various lifecycle events.
//* AWS IoT policies for device authorization.
//* AWS IoT Device Defender Audit to audit the device configuration using AWS IoT Device Defender Audit Checks. 
//** An SNS topic to receive device defender alerts.
//** A Lambda function to process / respond to the alert.
//* AWS IoT Device Defender ML detect to monitor device side metrics. 

=== CI/CD Pipeline

This project creates:

* CodeCommit repo in your account that is initialized with contents from the /submodules folder in the Github repo
* CI/CD enabled Amplify app that is triggered by commits to the CodeCommit repo (each commit will deploy updates to the backend and front end resources in your account)

All components described below are deployed as part of the initial Amplify app. You can customize by updating the CodeCommit repo.

=== App Components
==== Device Registration 
When a device first connects to AWS IoT Core with a new certificate, a message is sent to $aws/events/certificates/registered/${CACertificateID}. This triggers a lambda that

* Determines device Common Name (CN) from certificate
* Creates IoT thing using Common Name (CN) as the thingName
* Enters thing into product DynamoDB table without account so that a customer can later register this thing to their account
* Attaches the certificate to the IoT thing
* Adds the IoT thing to Inactive group with limited permissions
* Activates the certificate

=== End User Web App
The web application is a vuejs front end that is published by AWS Amplify. Amplify handles webpage file storage and distribution. The frontend interacts with the iotquickstartrest API Gateway. User identities are managed with Amazon Cognito. Users can exchange their credentials for a JWT token. All API calls must include the JWT in the Authorization header, which also provides the Lambda function to register the customerAccount.

The following API endpoints are available:

* /deviceData/{thingName}: GET, deviceData lambda, Queries the last telemetry data points (up to 1 MB) for customerAccount-thingName
* /devices: GET, listdevices lambda, Queries customers devices (up to 1 MB)
* /register/{thingName}: GET, if thing is in Inactive thing group and not registered to a customer in the Dynamodb products table, 
the Lambda function moves thing from Inactive to Active thing group, updates thingName in product table to have key account={customerAccount}, and adds thing attribute account={customerAccount}.
* /thingshadow/${thingName}: POST, body={key=${shadowKey}, value=${shadowDesiredValue}}, 
checks if thingName is registered to customerAccount in product DynamoDB table. If yes, update thing shadow with desired value.

=== Device Data
Registered and active IoT devices have permission to publish to dt/${thingName}/#. 
An IoT rule directs telemetry messages from this topic to a dynamodb telemetry table with primary key = customerId:thingName and sort key=Epoch timestamp. 
CustomerId is obtained from the thing attribute value for account and thingName is obtained from the topic.

=== Command and Control
Registered and active IoT devices have permissions to publish/subscribe to topics to interact with their shadow. These devices can publish to:
....
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get
....
and subscribe to:
....
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/accepted
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/rejected
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/documents
$aws/things/${iot:Connection.Thing.ThingName}/shadow/update/delta
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get/accepted
$aws/things/${iot:Connection.Thing.ThingName}/shadow/get/rejected
....
Devices should publish the "reported" values within the shadow and read from the "desired" values. Cloud interactions should publish to "desired" and read from "reported" values in the shadow.

=== Device Management
Before registration, devices are placed in a preset inactive group called ‘Inactive group’ with IoT policies not allowing communication between the device and AWS IoT Core. 
Upon registration and activation by the end user, devices are automatically placed under another preset active group 
with IoT policies granting the device the minimum privileges it needs to perform its functions. 
The Quick Start also creates two other device groups with their IoT policies for other device management use cases (e.g., troubleshooting, quarantining). 
All the IoT policies attached to the preset groups are customizable.

=== Security Management
https://docs.aws.amazon.com/iot/latest/developerguide/device-defender-audit.html[AWS IoT Device Defender Audit^] is configured for daily checks. 
The results are sent to SNS and the device defenderAlert lambda. The Lambda function currently does not perform any tasks but can be customized to respond to Audit or ML Detect alarms for automated mitigation, 
for example, you can create a mitigation action that moves a device to quarantine thing group if authorization failures exceed a limit. 
https://docs.aws.amazon.com/iot/latest/developerguide/dd-detect-ml.html[AWS IoT Device Defender ML detect^] 
is configured for monitoring device-level metrics including num-authorization-failures, message-byte-size, num-messages-sent, and num-messages-received.

NOTE: ML detect requires 14 days and a minimum of 25,000 datapoints per metric over the trailing 14-day period to build an initial model before it can perform device behavior evaluations.